export type TestType = 'web' | 'api' | 'mobile' | 'cloud' | 'network';
export type ScopeSize = 'small' | 'medium' | 'large';
export type AuthComplexity = 'none' | 'standard' | 'complex';
export type Environment = 'staging' | 'prod-like' | 'both';
export type Timeline = 'asap' | 'standard' | 'flexible';
export type ComplianceDriver = 'soc2' | 'pci' | 'iso' | 'customer' | 'none';

export interface PentestInput {
  testType: TestType;
  scope: ScopeSize;
  auth: AuthComplexity;
  environment: Environment;
  retest: boolean;
  timeline: Timeline;
  compliance?: ComplianceDriver;
}

const BASE_BY_TYPE: Record<TestType, number> = {
  web: 6000,
  api: 7000,
  mobile: 8000,
  cloud: 5000,
  network: 9000,
};

const SCOPE_MULTIPLIER: Record<ScopeSize, number> = {
  small: 1,
  medium: 1.5,
  large: 2.2,
};

const AUTH_ADDERS: Record<AuthComplexity, number> = {
  none: 0,
  standard: 1000,
  complex: 2500,
};

const ENV_ADDERS: Record<Environment, number> = {
  staging: 0,
  'prod-like': 1000,
  both: 2500,
};

const TIMELINE_ADDERS: Record<Timeline, number> = {
  asap: 2000,
  standard: 0,
  flexible: 0,
};

export interface PentestEstimate {
  total: number;
  low: number;
  high: number;
  drivers: string[];
}

export function estimatePentestCost(input: PentestInput): PentestEstimate {
  const base = BASE_BY_TYPE[input.testType];
  const scopeMultiplier = SCOPE_MULTIPLIER[input.scope];
  const authAdder = AUTH_ADDERS[input.auth];
  const envAdder = ENV_ADDERS[input.environment];
  const retestAdder = input.retest ? 1500 : 0;
  const timelineAdder = TIMELINE_ADDERS[input.timeline];

  const total = (base * scopeMultiplier) + authAdder + envAdder + retestAdder + timelineAdder;
  const low = Math.round(total * 0.85);
  const high = Math.round(total * 1.25);

  const drivers: string[] = [
    `Base scoped for ${describeTestType(input.testType)}`,
    `Scope size: ${formatLabel(input.scope)} (${scopeMultiplier}x)`,
  ];

  if (authAdder > 0) {
    drivers.push(`Auth complexity adds ${formatCurrency(authAdder)}`);
  }

  if (envAdder > 0) {
    drivers.push(`Environment coverage adds ${formatCurrency(envAdder)}`);
  }

  if (retestAdder > 0) {
    drivers.push('Includes one retest window');
  }

  if (timelineAdder > 0) {
    drivers.push('Accelerated timeline premium applied');
  }

  if (input.compliance && input.compliance !== 'none') {
    drivers.push(`Aligned to ${formatCompliance(input.compliance)} evidence expectations`);
  }

  return { total, low, high, drivers };
}

export function formatCurrency(value: number): string {
  return value.toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    maximumFractionDigits: 0,
  });
}

function describeTestType(type: TestType): string {
  switch (type) {
    case 'web':
      return 'a web application assessment';
    case 'api':
      return 'an API-first assessment';
    case 'mobile':
      return 'a mobile app assessment';
    case 'cloud':
      return 'a cloud configuration assessment';
    case 'network':
      return 'an internal/network assessment';
    default:
      return 'a pentest';
  }
}

function formatLabel(value: string): string {
  return value
    .split('-')
    .map((segment) => segment.charAt(0).toUpperCase() + segment.slice(1))
    .join(' ');
}

function formatCompliance(driver: ComplianceDriver): string {
  switch (driver) {
    case 'soc2':
      return 'SOC 2';
    case 'pci':
      return 'PCI DSS';
    case 'iso':
      return 'ISO 27001';
    case 'customer':
      return 'customer security review';
    default:
      return 'compliance';
  }
}
