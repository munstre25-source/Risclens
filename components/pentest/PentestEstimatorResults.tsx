import Link from 'next/link';
import { formatCurrency, PentestEstimate } from '@/lib/pentestEstimator';
import { useState, useEffect } from 'react';
import { PostResultsCTA } from '../PostResultsCTA';
import { trackEvent } from '@/lib/analytics';
import { MonetizationCTA } from '../MonetizationCTA';
import { HumanCheckCTA } from '../HumanCheckCTA';
import { AuditorMatchCTA } from '../AuditorMatchCTA';
import { EstimateDisclaimer } from '../EstimateDisclaimer';

interface Props {
  estimate: PentestEstimate;
  testTypeLabel: string;
  context: {
    testType: string;
    timeline: string;
    scope: string;
  };
}

export default function PentestEstimatorResults({ estimate, testTypeLabel, context }: Props) {
  useEffect(() => {
    trackEvent('pentest_results_viewed', {
      test_type: context.testType,
      timeline: context.timeline,
      scope: context.scope,
      estimate_low: estimate.low,
      estimate_high: estimate.high,
    });
  }, [estimate, context]);

  return (
    <div className="space-y-6">
      <div className="bg-slate-50 border border-slate-200 rounded-xl p-6">
        <p className="text-sm font-semibold text-slate-700 mb-2">Estimate</p>
          <div className="flex flex-wrap items-baseline gap-3">
            <p className="text-3xl font-bold text-slate-900">{formatCurrency(estimate.low)}</p>
            <span className="text-slate-500">to</span>
            <p className="text-3xl font-bold text-slate-900">{formatCurrency(estimate.high)}</p>
            <span className="text-sm text-slate-500">({testTypeLabel} scope)</span>
          </div>
          <p className="text-sm text-slate-600 mt-3">Range is deterministic and adjusts as you change inputs.</p>
          <EstimateDisclaimer variant="pentest" />
        </div>


      <div className="grid gap-4 md:grid-cols-2">
        <div className="border border-slate-200 rounded-xl p-5">
          <p className="text-sm font-semibold text-slate-700 mb-2">What drives cost</p>
          <ul className="space-y-2 text-slate-700 text-sm">
            {estimate.drivers.map((driver) => (
              <li key={driver} className="flex gap-2">
                <span className="text-brand-600">•</span>
                <span>{driver}</span>
              </li>
            ))}
          </ul>
        </div>
        <div className="border border-slate-200 rounded-xl p-5">
          <p className="text-sm font-semibold text-slate-700 mb-2">Recommended next steps</p>
          <ul className="space-y-2 text-slate-700 text-sm">
            <li className="flex gap-2">
              <span className="text-brand-600">•</span>
              <span>Confirm scope boundaries (apps, APIs, cloud accounts) and auth flows.</span>
            </li>
            <li className="flex gap-2">
              <span className="text-brand-600">•</span>
              <span>Align timelines with compliance drivers so evidence is usable for SOC 2 and customer reviews.</span>
            </li>
            <li className="flex gap-2">
              <span className="text-brand-600">•</span>
              <span>Bundle retest expectations in the statement of work to avoid surprise fees.</span>
            </li>
          </ul>
        </div>
      </div>

      <PostResultsCTA
        title="Get a pentest that matches your scope"
        description="Teams often overpay or test the wrong surface. We can sanity-check your scope and connect you to a vetted provider."
        primaryCtaLabel="Request Vendor Introduction"
        primaryCtaHref="/pentest-intro"
        primaryCtaOnClick={() => trackEvent('pentest_vendor_intro_cta_clicked')}
        footnote="No obligation. We don’t sell pentests ourselves."
      />

      <div className="space-y-6 mb-12">
        <AuditorMatchCTA type="pentest" context="Pentest Estimator" />
        <MonetizationCTA leadId={null} context="Pentest Estimator" />
        <HumanCheckCTA leadId={null} context="Pentest Estimator" />
      </div>

      <div className="flex justify-center">
        <Link
          href="/penetration-testing"
          className="text-sm text-slate-500 hover:text-brand-600 transition"
        >
          ← Back to Penetration Testing Guide
        </Link>
      </div>
    </div>
  );
}
