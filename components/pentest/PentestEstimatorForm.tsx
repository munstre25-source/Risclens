'use client';

import { useMemo, useState } from 'react';
import PentestEstimatorResults from './PentestEstimatorResults';
import {
  estimatePentestCost,
  PentestEstimate,
  PentestInput,
  TestType,
  ScopeSize,
  AuthComplexity,
  Environment,
  Timeline,
  ComplianceDriver,
} from '@/lib/pentestEstimator';

const TEST_TYPE_LABELS: Record<TestType, string> = {
  web: 'Web application',
  api: 'API',
  mobile: 'Mobile app',
  cloud: 'Cloud configuration',
  network: 'Network/internal',
};

export default function PentestEstimatorForm() {
  const [input, setInput] = useState<PentestInput>({
    testType: 'web',
    scope: 'small',
    auth: 'standard',
    environment: 'staging',
    retest: false,
    timeline: 'standard',
    compliance: 'soc2',
  });
  const [lead, setLead] = useState({ name: '', email: '', company: '', website: '' });
  const [showDetails, setShowDetails] = useState(false);
  const [showEstimateNotes, setShowEstimateNotes] = useState(false);
  const [estimate, setEstimate] = useState<PentestEstimate | null>(null);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [submitted, setSubmitted] = useState(false);
  const [hasCalculated, setHasCalculated] = useState(false);

  const testTypeLabel = useMemo(() => TEST_TYPE_LABELS[input.testType], [input.testType]);

  const handleChange = <K extends keyof PentestInput>(key: K, value: PentestInput[K]) => {
    setInput((prev) => ({ ...prev, [key]: value }));
  };

  const handleLeadChange = (key: 'name' | 'email' | 'company' | 'website', value: string) => {
    setLead((prev) => ({ ...prev, [key]: value }));
  };

  const onSubmit = async (e: React.FormEvent<HTMLFormElement>) => {
    e.preventDefault();
    setError(null);
    setIsSubmitting(true);

    const nextEstimate = estimatePentestCost(input);
    setEstimate(nextEstimate);
    setHasCalculated(true);

    try {
      if (lead.email.trim()) {
        const payload = {
          ...lead,
          company: lead.company?.trim() || undefined,
          website: lead.website?.trim() || undefined,
          test_type: input.testType,
          timeline: input.timeline,
          scope_size: input.scope,
          source_url: typeof window !== 'undefined' ? window.location.href : '',
          compliance: input.compliance,
          auth: input.auth,
          environment: input.environment,
          retest: input.retest,
          scope: input.scope,
        };

        const res = await fetch('/api/pentest-lead', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...payload, consent: true }),
        });

        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error((data as any).error || 'Unable to submit. Please try again.');
        }

        setSubmitted(true);
      }
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Something went wrong.');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <form onSubmit={onSubmit} className="space-y-8">
      <div className="grid gap-6 sm:grid-cols-2">
        <div className="space-y-2">
          <label className="form-label">Test Type</label>
          <select
            className="form-input"
            value={input.testType}
            onChange={(e) => handleChange('testType', e.target.value as TestType)}
          >
            <option value="web">Web application</option>
            <option value="api">API</option>
            <option value="mobile">Mobile app</option>
            <option value="cloud">Cloud configuration</option>
            <option value="network">Network/internal</option>
          </select>
        </div>
        <div className="space-y-2">
          <label className="form-label">Scope Size</label>
          <select
            className="form-input"
            value={input.scope}
            onChange={(e) => handleChange('scope', e.target.value as ScopeSize)}
          >
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large">Large</option>
          </select>
        </div>
        <div className="space-y-2">
          <label className="form-label">Auth Complexity</label>
          <select
            className="form-input"
            value={input.auth}
            onChange={(e) => handleChange('auth', e.target.value as AuthComplexity)}
          >
            <option value="none">Public / no auth</option>
            <option value="standard">Standard login / SSO</option>
            <option value="complex">Complex (MFA, roles, multiple flows)</option>
          </select>
        </div>
        <div className="space-y-2">
          <label className="form-label">Environments</label>
          <select
            className="form-input"
            value={input.environment}
            onChange={(e) => handleChange('environment', e.target.value as Environment)}
          >
            <option value="staging">Staging only</option>
            <option value="prod-like">Production-like staging</option>
            <option value="both">Both staging + production</option>
          </select>
        </div>
        <div className="space-y-2">
          <label className="form-label">Retest Included?</label>
          <select
            className="form-input"
            value={input.retest ? 'yes' : 'no'}
            onChange={(e) => handleChange('retest', e.target.value === 'yes')}
          >
            <option value="no">No</option>
            <option value="yes">Yes</option>
          </select>
        </div>
        <div className="space-y-2">
          <label className="form-label">Timeline</label>
          <select
            className="form-input"
            value={input.timeline}
            onChange={(e) => handleChange('timeline', e.target.value as Timeline)}
          >
            <option value="asap">ASAP (1–2 weeks)</option>
            <option value="standard">Standard (3–4 weeks)</option>
            <option value="flexible">Flexible (5–8 weeks)</option>
          </select>
        </div>
        <div className="space-y-2 sm:col-span-2">
          <label className="form-label">Compliance driver (optional)</label>
          <select
            className="form-input"
            value={input.compliance}
            onChange={(e) => handleChange('compliance', (e.target.value || 'none') as ComplianceDriver)}
          >
            <option value="soc2">SOC 2</option>
            <option value="pci">PCI DSS</option>
            <option value="iso">ISO 27001</option>
            <option value="customer">Customer requirement</option>
            <option value="none">None / exploratory</option>
          </select>
        </div>
      </div>

      {error && <p className="text-sm text-red-600">{error}</p>}

      <button
        type="submit"
        className="inline-flex items-center gap-2 rounded-lg bg-brand-600 px-6 py-3 text-white font-semibold shadow-sm hover:bg-brand-700 transition disabled:opacity-70"
        disabled={isSubmitting}
      >
        {isSubmitting ? 'Calculating…' : 'Calculate Pentest Estimate'}
        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </button>
      {submitted && lead.email.trim() && (
        <p className="text-sm text-green-600">Breakdown sent. We&apos;ll follow up with scope questions if needed.</p>
      )}

      <div className="space-y-4">
        {hasCalculated && estimate ? (
          <PentestEstimatorResults
            estimate={estimate}
            testTypeLabel={testTypeLabel}
            context={{ testType: input.testType, timeline: input.timeline, scope: input.scope }}
          />
        ) : (
          <div className="border border-dashed border-slate-300 rounded-xl p-6 text-slate-600">
            <p className="font-semibold text-slate-800 mb-2">Estimate preview</p>
            <p className="text-sm">Adjust inputs and submit to see deterministic pricing aligned to your scope.</p>
          </div>
        )}
      </div>

      <div className="border border-slate-200 rounded-xl p-6 bg-white space-y-4">
        <div className="grid gap-3 sm:grid-cols-2">
          <div>
            <label className="form-label">Email</label>
            <input
              className="form-input"
              type="email"
              required={false}
              value={lead.email}
              onChange={(e) => handleLeadChange('email', e.target.value)}
              placeholder="you@example.com"
            />
          </div>
          <div>
            <label className="form-label">Name (optional)</label>
            <input
              className="form-input"
              type="text"
              value={lead.name}
              onChange={(e) => handleLeadChange('name', e.target.value)}
              placeholder="Alex Rivera"
            />
          </div>
        </div>

        <div className="rounded-lg border border-slate-200 bg-slate-50">
          <button
            type="button"
            onClick={() => setShowDetails((prev) => !prev)}
            aria-expanded={showDetails}
            aria-controls="pentest-optional-details"
            className="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-900"
          >
            Add details (optional)
            <svg
              className={`w-4 h-4 transition-transform ${showDetails ? 'rotate-180' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          {showDetails && (
            <div id="pentest-optional-details" className="px-4 pb-4 space-y-3">
              <div>
                <label className="form-label">Company (optional)</label>
                <input
                  className="form-input"
                  type="text"
                  value={lead.company}
                  onChange={(e) => handleLeadChange('company', e.target.value)}
                  placeholder="Company name"
                />
              </div>
              <div>
                <label className="form-label">Website (optional)</label>
                <input
                  className="form-input"
                  type="url"
                  value={lead.website}
                  onChange={(e) => handleLeadChange('website', e.target.value)}
                  placeholder="https://"
                />
              </div>
            </div>
          )}
        </div>

        <button
          type="submit"
          className="inline-flex items-center gap-2 rounded-lg bg-brand-600 px-6 py-3 text-white font-semibold shadow-sm hover:bg-brand-700 transition disabled:opacity-70"
          disabled={isSubmitting}
        >
          {isSubmitting ? 'Working…' : 'Email me the breakdown'}
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 8l4 4m0 0l-4 4m4-4H3" />
          </svg>
        </button>
        {submitted && lead.email.trim() && (
          <p className="text-sm text-green-600">Breakdown sent. We&apos;ll follow up with scope questions if needed.</p>
        )}
        <p className="text-xs text-slate-600">Estimates are informational and not a binding quote.</p>
        <p className="text-xs text-slate-500">We only store details if you enter your email.</p>
      </div>

      <div className="border border-slate-200 rounded-xl bg-slate-50">
        <button
          type="button"
          onClick={() => setShowEstimateNotes((prev) => !prev)}
          aria-expanded={showEstimateNotes}
          aria-controls="pentest-how-estimate"
          className="w-full flex items-center justify-between px-4 py-3 text-sm font-semibold text-slate-900"
        >
          How we estimate
          <svg
            className={`w-4 h-4 transition-transform ${showEstimateNotes ? 'rotate-180' : ''}`}
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        {showEstimateNotes && (
          <div id="pentest-how-estimate" className="px-4 pb-4 text-sm text-slate-700 space-y-2">
            <ul className="space-y-1">
              <li>• Scope and auth complexity drive effort; we budget retests up front.</li>
              <li>• Ranges stay tight to align with SOC 2 evidence and customer asks.</li>
              <li>• Planning guidance only—not a guaranteed or binding quote.</li>
            </ul>
          </div>
        )}
      </div>
    </form>
  );
}
