import { NextRequest, NextResponse } from 'next/server';
import { z } from 'zod';
import { logAuditEvent } from '@/lib/supabase';
import { createLead } from '@/lib/leads';

const payloadSchema = z
  .object({
    name: z.string().trim().max(120).optional(),
    email: z.string().trim().toLowerCase().email().optional(),
    company: z.string().trim().max(160).optional(),
    website: z.string().trim().max(200).optional(),
    test_type: z.string().trim().max(32),
    timeline: z.string().trim().max(32),
    scope_size: z.string().trim().max(32),
    compliance: z.string().trim().max(32).optional(),
    source_url: z.string().trim().max(240).optional(),
    auth: z.string().trim().max(32).optional(),
    environment: z.string().trim().max(32).optional(),
    retest: z.boolean().optional(),
    scope: z.string().trim().max(32).optional(),
    help_notes: z.string().trim().max(1000).optional(),
    consent: z.boolean().default(true),
  })
  .strict();

export async function POST(request: NextRequest) {
  const raw = await request.json().catch(() => null);
  if (!raw) {
    return NextResponse.json({ error: 'invalid_json' }, { status: 400 });
  }

  const parsed = payloadSchema.safeParse(raw);
  if (!parsed.success) {
    return NextResponse.json({ error: 'validation_error', details: parsed.error.flatten() }, { status: 400 });
  }

  const data = parsed.data;

  if (!data.email) {
    return NextResponse.json({ ok: true });
  }

  try {
    const leadPayload = {
      test_type: data.test_type,
      timeline: data.timeline,
      scope_size: data.scope_size,
      compliance: data.compliance ?? null,
      source_url: data.source_url ?? null,
      auth: data.auth ?? null,
      environment: data.environment ?? null,
      retest: data.retest ?? null,
      scope: data.scope ?? null,
      help_notes: data.help_notes ?? null,
    };

    const leadResult = await createLead({
      name: data.name,
      email: data.email,
      company: data.company ?? null,
      website: data.website ?? null,
      sourceUrl: data.source_url ?? null,
      leadType: 'pentest_estimate',
      payload: leadPayload,
      derivedFields: {
        contextNote: data.name ? `Pentest lead from ${data.name}` : 'Pentest lead',
        role: 'pentest',
        variationId: 'pentest',
        leadScore: null,
        keepOrSell: 'sell',
      },
    });

    if (!leadResult.ok) {
      return NextResponse.json({ error: 'insert_failed' }, { status: 500 });
    }

    await logAuditEvent('pentest_lead_submitted', {
      email: data.email,
      test_type: data.test_type,
      timeline: data.timeline,
      scope_size: data.scope_size,
      source_url: data.source_url ?? '',
      timestamp: new Date().toISOString(),
    }).catch(console.error);

    return NextResponse.json({ ok: true });
  } catch (error) {
    console.error('Pentest lead failure', error);
    return NextResponse.json({ error: 'server_error' }, { status: 500 });
  }
}
